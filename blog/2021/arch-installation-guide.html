<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-02-07 Mon 17:00 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Arch 安装指南</title>
<meta name="generator" content="Org mode">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/base16/dracula.min.css">
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js"></script>
<link rel="stylesheet" href="/theme/site.css"/>
<script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "d5b841b503ed4d1b8fad459b84d1cc2f"}'></script>
<script defer src="/theme/main.js"></script>
</head>
<body>
<div id="content">
<header>
<h1 class="title">Arch 安装指南</h1>
</header><p>
安装过程整体顺利，没有无法解决的问题，主要参考资料：
</p>

<ol class="org-ol">
<li><a href="https://io-oi.me/tech/hello-arch-linux/">https://io-oi.me/tech/hello-arch-linux/</a></li>
<li><a href="https://wiki.archlinux.org/">https://wiki.archlinux.org/</a></li>
<li>Google</li>
</ol>

<p>
除此之外，还有
<a href="https://python-archinstall.readthedocs.io/en/latest/index.html">archinstall</a>
</p>

<div id="outline-container-初始安装" class="outline-2">
<h2 id="初始安装">初始安装</h2>
<div class="outline-text-2" id="text-初始安装">
</div>
<div id="outline-container-更改-bios 使用-usb-系统启动盘优先启动" class="outline-3">
<h3 id="更改-bios 使用-usb-系统启动盘优先启动">更改 BIOS，使用 USB 系统启动盘优先启动</h3>
<div class="outline-text-3" id="text-更改-bios 使用-usb-系统启动盘优先启动">
<p>
插入制作好的 arch linux USB 启动盘，当前目录下并无
install.txt（详见参考资料 1）。
</p>
</div>
</div>

<div id="outline-container-验证-uefi" class="outline-3">
<h3 id="验证-uefi">验证 UEFI</h3>
<div class="outline-text-3" id="text-验证-uefi">
<p>
<code>ls /sys/firmware/efi/efivars</code> 有输出，说明启动模式为 UEFI。
</p>
</div>
</div>

<div id="outline-container-验证网络" class="outline-3">
<h3 id="验证网络">验证网络</h3>
<div class="outline-text-3" id="text-验证网络">
<p>
<code>ping archlinux.org -c 3</code> 验证网络，0% packet loss 说明网络正常。
</p>
</div>
</div>

<div id="outline-container-更新系统时间" class="outline-3">
<h3 id="更新系统时间">更新系统时间</h3>
<div class="outline-text-3" id="text-更新系统时间">
<p>
<code>timedatectl set-ntp true</code> 更新系统时间，=timedatectl status= 检查无误。
</p>
</div>
</div>

<div id="outline-container-硬盘分区" class="outline-3">
<h3 id="硬盘分区">硬盘分区</h3>
<div class="outline-text-3" id="text-硬盘分区">
<ol class="org-ol">
<li><code>fdisk -l</code> 查看硬盘信息：sdb 119.24g 固态，sda 931.51g 机械</li>
<li><code>fdisk /dev/sdb</code> 固态硬盘分区</li>
</ol>

<p>
进入 fdisk 操作界面后，m 查看命令帮助，p 显示目标硬盘分区，g 新建 GPT
分区表。创建 sdb1 分区，n 创建分区、分区序号、类型起始扇区默认，结束扇区
+256M。修改分区类型为 EFI System，p 确认为 EFI System。创建 sdb2
分区，全部默认。我的安装移除了原系统的 signature。
</p>

<p>
分区结果：
</p>

<pre class="example" id="org1bb2aaf">
Device      Start       End   Sectors  Size Type
/dev/sdb1    2048    526335    524288  256M EFI System
/dev/sdb2  526336 250069646 249543311  119G Linux filesystem
</pre>

<p>
关于是否分配 SWAP
分区的讨论：<a href="https://bbs.archlinuxcn.org/viewtopic.php?id=10472">https://bbs.archlinuxcn.org/viewtopic.php?id=10472</a>
</p>

<p>
机械硬盘 sda 作为挂载硬盘存储文件。
</p>
</div>
</div>

<div id="outline-container-硬盘格式化新建文件系统" class="outline-3">
<h3 id="硬盘格式化新建文件系统">硬盘格式化、新建文件系统</h3>
<div class="outline-text-3" id="text-硬盘格式化新建文件系统">
<pre class="example" id="orge4409ae">
mkfs.fat -F32 /dev/sdb1
mkfs.ext4 /dev/sdb2
mkfs.ext4 /dev/sda
</pre>
</div>
</div>

<div id="outline-container-挂载分区" class="outline-3">
<h3 id="挂载分区">挂载分区</h3>
<div class="outline-text-3" id="text-挂载分区">
<pre class="example" id="org2db79fb">
mount /dev/sdb2 /mnt
mkdir -p /mnt/boot/efi
mount /dev/sdb1 /mnt/boot/efi
</pre>
</div>
</div>

<div id="outline-container-选择镜像源" class="outline-3">
<h3 id="选择镜像源">选择镜像源</h3>
<div class="outline-text-3" id="text-选择镜像源">
<pre class="example" id="orge203cd1">
pacman -Syyy reflector # reflector 能够方便地选择镜像源
reflector -c China -a 6 --sort rate --save /etc/pacman.d/mirrorlist # 这里的 mirrorlist 是 U 盘中的，还是硬盘中的？U 盘中的
pacman -Syyy # y 刷新本地缓存 yyy 强制刷新
</pre>
</div>
</div>

<div id="outline-container-安装基本系统和安装时要用的应用到硬盘" class="outline-3">
<h3 id="安装基本系统和安装时要用的应用到硬盘">安装基本系统和安装时要用的应用到硬盘</h3>
<div class="outline-text-3" id="text-安装基本系统和安装时要用的应用到硬盘">
<pre class="example" id="org84dae0c">
pacstrap -i /mnt base base-devel linux linux-firmware dhcpcd vim
</pre>
</div>
</div>
</div>

<div id="outline-container-配置系统" class="outline-2">
<h2 id="配置系统">配置系统</h2>
<div class="outline-text-2" id="text-配置系统">
</div>
<div id="outline-container-进入硬盘而不在-u-盘" class="outline-3">
<h3 id="进入硬盘而不在-u-盘">进入硬盘，而不在 U 盘</h3>
<div class="outline-text-3" id="text-进入硬盘而不在-u-盘">
<pre class="example" id="orgedd63a0">
arch-chroot /mnt /bin/bash
</pre>
</div>
</div>

<div id="outline-container-生成挂载表" class="outline-3">
<h3 id="生成挂载表">生成挂载表</h3>
<div class="outline-text-3" id="text-生成挂载表">
<pre class="example" id="org4aac709">
genfstab -U -p /mnt &gt;&gt; /mnt/etc/fstab
</pre>

<p>
检查：
</p>

<pre class="example" id="org41b7a07">
cat /mnt/etc/fstab
</pre>
</div>
</div>

<div id="outline-container-时区和语言" class="outline-3">
<h3 id="时区和语言">时区和语言</h3>
<div class="outline-text-3" id="text-时区和语言">
<p>
设置时区：
</p>

<pre class="example" id="orgeb6f842">
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
hwclock --systohc --utc
</pre>

<p>
配置系统语言环境:
</p>

<p>
<code>vim /etc/locale.gen</code> 取消注释：
</p>

<pre class="example" id="orgc41755e">
en_US.UTF-8 UTF-8
...
zh_CN.UTF-8 UTF-8
</pre>

<p>
生成配置：
</p>

<pre class="example" id="orgfd54382">
locale-gen
</pre>

<p>
设置本地语言环境:
</p>

<p>
<code>vim /etc/locale.conf</code> 输入：
</p>

<pre class="example" id="org3d0f7b7">
LANG=en_US.UTF-8
</pre>
</div>
</div>

<div id="outline-container-安装引导程序" class="outline-3">
<h3 id="安装引导程序">安装引导程序</h3>
<div class="outline-text-3" id="text-安装引导程序">
<pre class="example" id="org06015a0">
pacman -S grub efibootmgr
grub-install --target=x86_64-efi --bootloader-id=GRUB --efi-directory=/boot/efi
grub-mkconfig -o /boot/grub/grub.cfg
</pre>

<p>
运行 grub
相关操作时，会出现警告：=Warning: os-prober will not be executed to detect other bootable partitions.=。查
arch wiki 后，可以在 /etc/default/grub 中设置
=GRUB_DISABLE_OS_PROBER=false=。
</p>
</div>
</div>

<div id="outline-container-设置主机名" class="outline-3">
<h3 id="设置主机名">设置主机名</h3>
<div class="outline-text-3" id="text-设置主机名">
<pre class="example" id="orgc80b6cb">
echo arch &gt; /etc/hostname
</pre>

<p>
<code>vim /etc/hosts</code> 添加以下内容：
</p>

<pre class="example" id="org45204c0">
127.0.0.1 localhost
::1 localhost
127.0.0.1 arch.localdomain arch
</pre>
</div>
</div>

<div id="outline-container-提前配置网络" class="outline-3">
<h3 id="提前配置网络">提前配置网络</h3>
<div class="outline-text-3" id="text-提前配置网络">
<pre class="example" id="org8b7d43b">
pacman -S networkmanager
systemctl enable NetworkManager
systemctl start NetworkManager
systemctl status NetworkManager # 检查是否运行
</pre>
</div>
</div>

<div id="outline-container-设置-root-密码" class="outline-3">
<h3 id="设置-root-密码">设置 root 密码</h3>
<div class="outline-text-3" id="text-设置-root-密码">
<pre class="example" id="org51d2000">
passwd
</pre>
</div>
</div>

<div id="outline-container-新建普通用户" class="outline-3">
<h3 id="新建普通用户">新建普通用户</h3>
<div class="outline-text-3" id="text-新建普通用户">
<pre class="example" id="orgfe607d3">
useradd -m -g users -G wheel -s /bin/bash archie
</pre>

<p>
设置普通用户密码：
</p>

<pre class="example" id="orga4d45b8">
passwd archie
</pre>

<p>
设置普通用户权限:
</p>

<pre class="example" id="org509b787">
EDITOR=vim visudo
</pre>

<p>
取消注释：
</p>

<pre class="example" id="orgf9efdf7">
## Uncomment to allow members of group wheel to execute any command

%wheel ALL=(ALL) ALL

## Same thing without a password

%wheel ALL=(ALL) NOPASSWD: ALL
</pre>
</div>
</div>

<div id="outline-container-返回-u-盘" class="outline-3">
<h3 id="返回-u-盘">返回 U 盘</h3>
<div class="outline-text-3" id="text-返回-u-盘">
<pre class="example" id="org8ccae94">
exit
</pre>
</div>
</div>
</div>

<div id="outline-container-重启系统" class="outline-2">
<h2 id="重启系统">重启系统</h2>
<div class="outline-text-2" id="text-重启系统">
<pre class="example" id="org0d0b4fd">
umount -R /mnt
reboot
</pre>

<p>
开机后改动 BIOS，配置「系统启动」后，拔掉 U 盘。普通用户 archie 登录。
</p>
</div>
</div>

<div id="outline-container-完善系统" class="outline-2">
<h2 id="完善系统">完善系统</h2>
<div class="outline-text-2" id="text-完善系统">
</div>
<div id="outline-container-启动微码更新" class="outline-3">
<h3 id="启动微码更新">启动微码更新</h3>
<div class="outline-text-3" id="text-启动微码更新">
<pre class="example" id="org4e2fc7f">
sudo pacman -S intel-ucode
sudo grub-mkconfig -o /boot/grub/grub.cfg
</pre>
</div>
</div>

<div id="outline-container-完善显卡驱动" class="outline-3">
<h3 id="完善显卡驱动">完善显卡驱动</h3>
<div class="outline-text-3" id="text-完善显卡驱动">
<p>
这一步要在知道自己显卡配置的前提下执行。
</p>
</div>

<div id="outline-container-va-api-or-vdpau" class="outline-4">
<h4 id="va-api-or-vdpau">VA-API or VDPAU</h4>
<div class="outline-text-4" id="text-va-api-or-vdpau">
<pre class="example" id="org22bb0bc">
sudo pacman -S libva-utils vdpauinfo
vainfo
vdpauinfo
</pre>

<pre class="example" id="org838530d">
vainfo: VA-API version: 1.12 (libva 2.12.0) vainfo: Driver
version: Intel iHD driver for Intel(R) Gen Graphics - 21.3.2 ()
vainfo: Supported profile and entrypoints VAProfileNone :
VAEntrypointVideoProc VAProfileNone : VAEntrypointStats
VAProfileMPEG2Simple : VAEntrypointVLD VAProfileMPEG2Simple :
VAEntrypointEncSlice VAProfileMPEG2Main : VAEntrypointVLD
VAProfileMPEG2Main : VAEntrypointEncSlice VAProfileH264Main :
VAEntrypointVLD VAProfileH264Main : VAEntrypointEncSlice
VAProfileH264Main : VAEntrypointFEI VAProfileH264Main :
VAEntrypointEncSliceLP VAProfileH264High : VAEntrypointVLD
VAProfileH264High : VAEntrypointEncSlice VAProfileH264High :
VAEntrypointFEI VAProfileH264High : VAEntrypointEncSliceLP
VAProfileVC1Simple : VAEntrypointVLD VAProfileVC1Main :
VAEntrypointVLD VAProfileVC1Advanced : VAEntrypointVLD
VAProfileJPEGBaseline : VAEntrypointVLD VAProfileJPEGBaseline :
VAEntrypointEncPicture VAProfileH264ConstrainedBaseline:
VAEntrypointVLD VAProfileH264ConstrainedBaseline: VAEntrypointEncSlice
VAProfileH264ConstrainedBaseline: VAEntrypointFEI
VAProfileH264ConstrainedBaseline: VAEntrypointEncSliceLP
VAProfileVP8Version0\_3 : VAEntrypointVLD VAProfileVP8Version0\_3 :
VAEntrypointEncSlice VAProfileHEVCMain : VAEntrypointVLD
VAProfileHEVCMain : VAEntrypointEncSlice VAProfileHEVCMain :
VAEntrypointFEI VAProfileHEVCMain10 : VAEntrypointVLD
VAProfileHEVCMain10 : VAEntrypointEncSlice VAProfileVP9Profile0 :
VAEntrypointVLD VAProfileVP9Profile2 : VAEntrypointVLD

display: :0 screen: 0 Failed to open VDPAU backend
libvdpau\_va\_gl.so: cannot open shared object file: No such file or
directory Error creating VDPAU device: 1
</pre>

<p>
So mine is VA-API, I supposed to install
<a href="https://wiki.archlinux.org/title/Hardware_video_acceleration#:~:text=VA-API%20on%20Radeon%20HD%202000%20and%20newer%20GPUs">libva-mesa-driver</a>.
</p>

<p>
我的两种 GPU：
</p>

<p>
00:02.0 VGA compatible controller: Intel Corporation UHD Graphics 620
(rev 07) 01:00.0 Display controller: Advanced Micro Devices, Inc.
[AMD/ATI] Topaz XT [Radeon R7 M260/M265 / M340/M360 / M440/M445 /
530/535 / 620/625 Mobile] (rev c3)
</p>

<ul class="org-ul">
<li>Radeon R7 M260(Topaz)
<a href="https://en.wikipedia.org/wiki/List_of_AMD_graphics_processing_units#Radeon_R5/R7/R9_M200_series">https://en.wikipedia.org/wiki/List_of_AMD_graphics_processing_units#Radeon_R5/R7/R9_M200_series</a></li>
</ul>

<pre class="example" id="org1396de9">
sudo pacman -S xf86-video-intel intel-media-driver vulkan-intel xf86-video-amdgpu xf86-video-ati mesa-vdpau vulkan-radeon
</pre>

<p>
不推荐安装 =xf86-video-intel=，详见
<a href="https://wiki.archlinux.org/title/Intel_graphics#:~:text=Often%20not%20recommended%2C%20see%20note%20below">Intel
graphics - ArchWiki</a>
</p>

<p>
CPU
的详细信息：<a href="https://en.wikipedia.org/wiki/List_of_Intel_graphics_processing_units#:~:text=38.4-,Core%20i5-8250U,-Core%20i5-8350U">https://en.wikipedia.org/wiki/List_of_Intel_graphics_processing_units#:~:text=38.4-,Core%20i5-8250U,-Core%20i5-8350U</a>
</p>

<p>
HDMI audio:
<a href="https://wiki.archlinux.org/title/ATI#:~:text=HDMI%20audio%20is%20supported">https://wiki.archlinux.org/title/ATI#:~:text=HDMI%20audio%20is%20supported</a>
</p>

<p>
ref:
</p>

<ol class="org-ol">
<li><a href="https://wiki.archlinux.org/title/Hardware_video_acceleration">https://wiki.archlinux.org/title/Hardware_video_acceleration</a></li>
<li><a href="https://wiki.archlinux.org/title/Vulkan">https://wiki.archlinux.org/title/Vulkan</a></li>
<li><a href="https://wiki.archlinux.org/title/Xorg#Driver_installation">https://wiki.archlinux.org/title/Xorg#Driver_installation</a></li>
<li><a href="https://wiki.archlinux.org/title/Hardware_video_acceleration#:~:text=VDPAU%20on%20Radeon%20R300%20and%20newer%20GPUs">https://wiki.archlinux.org/title/Hardware_video_acceleration#:~:text=VDPAU%20on%20Radeon%20R300%20and%20newer%20GPUs</a></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-安装图形界面" class="outline-3">
<h3 id="安装图形界面">安装图形界面</h3>
<div class="outline-text-3" id="text-安装图形界面">
<pre class="example" id="org5ce9acd">
sudo pacman -S xorg xorg-server xorg-xinit plasma # gnome gnome-extra
# systemctl enable gdm
systemctl enable sddm # for kde(plasma)
</pre>

<p>
桌面环境为 GNOME 时，切换 Wayland 至 Xorg：
</p>

<pre class="example" id="org4945b4e">
sudo vim /etc/gdm/custom.conf
</pre>

<p>
<code>/etc/gdm/custom.conf</code>:
</p>

<pre class="example" id="org48abf68">
[daemon]
# Uncoment the line below to force the login screen to use Xorg
-#WaylandEnable=false
+WaylandEnable=false
</pre>

<p>
重启后，图形界面打开，但无法打开 Gnome Terminal，通过 Ctrl+Alt+F2
进入命令行模式，输入 gnome-terminal 显示：
</p>

<pre class="example" id="org2868638">
# Locale not supported by C library.
# Using the fallback 'C' locale
Unable to init server: Could not connect: Connection refused
# Failed to parse arguments: Cannot open display!
</pre>

<p>
解决：在配置系统语言环境时，选择了 es_US，而不是 en_US。
</p>
</div>
</div>

<div id="outline-container-ssd-优化" class="outline-3">
<h3 id="ssd-优化">SSD 优化</h3>
<div class="outline-text-3" id="text-ssd-优化">
</div>
<div id="outline-container-开启 trim" class="outline-4">
<h4 id="开启 trim">开启 TRIM</h4>
<div class="outline-text-4" id="text-开启 trim">
<p>
一定要确认固态硬盘是否支持，否则别用。会导致数据丢失
</p>

<p>
查看是否支持：=lsblk &#x2013;discard= 如果输出的 DISC-GRAN 和 DISC-MAX 不为
0，则表明支持。
</p>

<pre class="example" id="orgb995c36">
sudo vim /etc/fstab
</pre>

<p>
添加 noatime 和 diacard：
</p>

<pre class="example" id="orge9dc751">
# &lt;file system&gt; &lt;dir&gt; &lt;type&gt; &lt;options&gt; &lt;dump&gt; &lt;pass&gt;
# /dev/sdb2
UUID=b182ad17-2f74-4bf0-95b6-a42884a4ff79 /          ext4       rw,noatime,discard 0 1

# /dev/sdb1
UUID=EF6F-2E0C       /boot/efi  vfat       rw,noatime,discard,fmask=0022,dmask=0022,codepage=437,iocharset=ascii,shortname=mixed,utf8,errors=remount-ro 0 2
</pre>
</div>
</div>

<div id="outline-container-更换-io-scheduler" class="outline-4">
<h4 id="更换-io-scheduler">更换 I/O  scheduler</h4>
<div class="outline-text-4" id="text-更换-io-scheduler">
<pre class="example" id="org5309933">
sudo vim /etc/default/grub
</pre>

<p>
找到 <code>GRUB_CMDLINE_LINUX_DEFAULT</code> 这一行，添加 <code>elevator=noop</code>:
</p>

<pre class="example" id="org527b28f">
GRUB_CMDLINE_LINUX_DEFAULT="elevator=noop loglevel=3 quiet"
</pre>

<pre class="example" id="org2555234">
sudo grub-mkconfig -o /boot/grub/grub.cfg
</pre>
</div>
</div>

<div id="outline-container-迁移高读写文件到-tmpfs" class="outline-4">
<h4 id="迁移高读写文件到-tmpfs">迁移高读写文件到 tmpfs</h4>
<div class="outline-text-4" id="text-迁移高读写文件到-tmpfs">
<pre class="example" id="orgd9293f9">
sudo vim /etc/fstab
</pre>

<p>
添加以下内容到最后：
</p>

<pre class="example" id="org28e0da9">
tmpfs  /tmp    tmpfs   defaults,noatime,mode=1777 0 0
tmpfs  /var/log    tmpfs   defaults,noatime,mode=1777 0 0
tmpfs  /var/tmp    tmpfs   defaults,noatime,mode=1777 0 0
</pre>

<p>
将 Google Chrome 的缓存挂载到 /tmp（后因排查
<a href="https://github.com/tianheg/blog/issues/147">arch linux system freeze
after connecting wifi</a> 问题取消挂载）：
</p>

<pre class="example" id="orgccd33c4">
cd ~/.cache/google-chrome/Default/ &amp;&amp; rm -rf Cache &amp;&amp; ln -sf /tmp Cache
cd ~/.cache/google-chrome/Default/ &amp;&amp; unlink Cache # 取消 Symbolic Link
</pre>
</div>
</div>
</div>

<div id="outline-container-检查硬盘状况" class="outline-3">
<h3 id="检查硬盘状况">检查硬盘状况</h3>
<div class="outline-text-3" id="text-检查硬盘状况">
<pre class="example" id="orga8f024c">
sudo pacman -S hdparm smartmontools
sudo hdparm -I /dev/sdb
sudo smartctl -t short /dev/sdb
</pre>
</div>
</div>

<div id="outline-container-测试固态硬盘速度" class="outline-3">
<h3 id="测试固态硬盘速度">测试固态硬盘速度</h3>
<div class="outline-text-3" id="text-测试固态硬盘速度">
<pre class="example" id="org4383bcf">
sudo dd if=/dev/zero of=/tmp/test.img bs=1G count=1 oflag=dsync
</pre>

<p>
至此系统完善到此告一段落。
</p>
</div>
</div>
</div>

<div id="outline-container-其他" class="outline-2">
<h2 id="其他">其他</h2>
<div class="outline-text-2" id="text-其他">
<ul class="org-ul">
<li><a href="https://nyac.at/4">在阿里云服务器上安装 Arch Linux</a></li>
</ul>
</div>
</div>
</div>
</body>
</html>