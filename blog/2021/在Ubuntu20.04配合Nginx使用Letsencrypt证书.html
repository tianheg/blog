<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-11-29 Mon 22:03 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org mode" />
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#安装-certbot">1. 安装 Certbot</a></li>
<li><a href="#配置-nginx">2. 配置 Nginx</a></li>
<li><a href="#获取一个-ssl-证书">3. 获取一个 SSL 证书</a></li>
<li><a href="#验证-certbot-自动更新">4. 验证 Certbot 自动更新</a></li>
</ul>
</div>
</div>
<p>
<del>+</del> date = '2021-10-22T21:53:21+08:00' title = "在 Ubuntu20.04 配合
Nginx 使用 Let's Encrypt 证书" tags = ['Nginx', 'Ubuntu', "Let's
Encrypt"] slug = 'install-letsencrypt-with-nginx-on-ubuntu20.04' <del>+</del>
</p>

<p>
进行以下步骤的前提：
</p>

<ol class="org-ol">
<li>有一台已经初始安装的 Ubuntu20.04 服务器，包括一个能够 sudo 的非 root
的用户和防火墙</li>
<li>一个已注册的域名</li>
<li>域名已经和当前服务器 IP 绑定</li>
<li><a href="file:///posts/first-use-nginx/">Nginx 已经安装并能够正常使用</a></li>
</ol>

<div id="outline-container-安装-certbot" class="outline-2">
<h2 id="安装-certbot"><span class="section-number-2">1</span> 安装 Certbot</h2>
<div class="outline-text-2" id="text-安装-certbot">
<pre class="example" id="org07bb032">
sudo apt install certbot python3-certbot-nginx
</pre>
</div>
</div>

<div id="outline-container-配置-nginx" class="outline-2">
<h2 id="配置-nginx"><span class="section-number-2">2</span> 配置 Nginx</h2>
<div class="outline-text-2" id="text-配置-nginx">
<p>
我已经通过 Nginx
部署了一个站点-&#x2013;&#x2014;blog.yidajiabei.xyz，现在部署的是第二个站点-&#x2013;&#x2014;til.yidajiabei.xyz。我没有使用
server block<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>，即新建
<code>/etc/nginx/sites-available/til.yidajiabei.xyz</code> 文件，并通过
<code>sudo ln -s /etc/nginx/sites-available/til.yidajiabei.xyz /etc/nginx/sites-enabled/</code>
命令链接至 <code>sites-enabled</code> 文件夹下。而是直接将配置写在
<code>/etc/nginx/nginx.conf</code> 文件中。
</p>

<pre class="example" id="org939f9d4">
http {
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    server {
        listen 443 ssl;
    server_name til.yidajiabei.xyz;
    ssl_session_timeout 5m;
    location / {
        root /var/www/til;
        index index.html index.htm;
    }
    }
    server {
        listen 80;
    server_name til.yidajiabei.xyz;
    rewrite ^(.*) https://$server_name$1 permanent;
    }
}
</pre>

<p>
你可以看到有两个 server，前一个是配置 HTTPS 的，后一个是把 HTTP 重定向至
HTTPS。而且，第一个 server 中缺少 SSL 证书和密匙，这两个配置是由 Certbot
自动添加的。
</p>
</div>
</div>

<div id="outline-container-获取一个-ssl-证书" class="outline-2">
<h2 id="获取一个-ssl-证书"><span class="section-number-2">3</span> 获取一个 SSL 证书</h2>
<div class="outline-text-2" id="text-获取一个-ssl-证书">
<pre class="example" id="org00a5b84">
sudo certbot --nginx -d til.yidajiabei.xyz
</pre>

<p>
按照提示一步步操作，如果没有异常，就能够获得 SSL 证书，位置在
<code>/etc/letsencrypt/live/til.yidajiabei.xyz/=，此时
=/etc/nginx/nginx.conf</code> 文件也会发生变化：
</p>

<pre class="example" id="org89f78be">
http {
    ...
    server {
        listen 443 ssl;
        server_name til.yidajiabei.xyz;
    ssl_certificate /etc/letsencrypt/live/til.yidajiabei.xyz/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/til.yidajiabei.xyz/privkey.pem; # managed by Certbot
        ssl_session_timeout 5m;
        ...
    }
    ...
}
</pre>
</div>
</div>

<div id="outline-container-验证-certbot-自动更新" class="outline-2">
<h2 id="验证-certbot-自动更新"><span class="section-number-2">4</span> 验证 Certbot 自动更新</h2>
<div class="outline-text-2" id="text-验证-certbot-自动更新">
<pre class="example" id="orgafc5f78">
sudo systemctl status certbot.timer
● certbot.timer - Run certbot twice daily
     Loaded: loaded (/lib/systemd/system/certbot.timer; enabled; vendor preset: enabled)
     Active: active (waiting) since Fri 2021-10-22 09:38:04 CST; 6h ago
    Trigger: Sat 2021-10-23 04:10:06 CST; 12h left
   Triggers: ● certbot.service

Oct 22 09:38:04 VM-4-5-ubuntu systemd[1]: Started Run certbot twice daily.
</pre>

<p>
Certbot 自动更新正常运行。还可以通过以下命令测试「更新证书」这一过程：
</p>

<pre class="example" id="org418e278">
sudo certbot renew --dry-run
</pre>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
<a href="https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-20-04">https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-20-04</a>
</p></div></div>


</div>
</div></div>
</body>
</html>