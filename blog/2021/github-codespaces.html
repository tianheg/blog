<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-02-07 Mon 12:01 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>配置 GitHub Codespaces 初始环境</title>
<meta name="generator" content="Org mode">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/base16/dracula.min.css">
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js"></script>
<link rel="stylesheet" href="/theme/site.css"/>
<script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "d5b841b503ed4d1b8fad459b84d1cc2f"}'></script>
<script defer src="/theme/main.js"></script>
</head>
<body>
<div id="content">
<header>
<h1 class="title">配置 GitHub Codespaces 初始环境</h1>
</header><p>
我想在 Codespace 里用 ohmyzsh，于是在 GitHub
寻找办法。我真的找到<a href="https://github.com/codespaces-examples/base">一个</a>，但是直接拿过来用不了，初始化环境时很多错误。经过我多次修改能够使用了，预装了
ohmyzsh 和 nvm，如果你想尝试可以使用我的新仓库模板
<a href="https://github.com/tianheg/new-repo-template">tianheg/new-repo-template</a>。
</p>

<p>
文件结构：
</p>

<pre class="example" id="org41fbf41">
.devcontainer
--&gt;devcontainer.json
--&gt;Dockerfile
--&gt;setup.sh
</pre>

<p>
devcontainer.json:
</p>

<div class="org-src-container">
<pre class="src src-json">{
    "name": "Codespaces Basic Starter",
    "extensions": [
        "eamodio.gitlens",
        "deibit.devdocs",
        "knisterpeter.vscode-github",
        "github.copilot",
        "oderwat.indent-rainbow",
        "yzhang.markdown-all-in-one",
        "davidanson.vscode-markdownlint",
        "christian-kohler.path-intellisense",
        "alefragnani.project-manager",
        "tds.taptap-vscode-theme",
        "octref.vetur",
        "vscode-icons-team.vscode-icons",
        "wakatime.vscode-wakatime",
        "guoruibiao.wordcount",
        "formulahendry.code-runner",
        "dbaeumer.vscode-eslint",
        "github.vscode-pull-request-github",
        "budparr.language-hugo-vscode",
        "ritwickdey.liveserver",
        "eg2.vscode-npm-script",
        "xlthu.pangu-markdown",
        "esbenp.prettier-vscode",
        "ms-python.python",
        "stylelint.vscode-stylelint"
    ],
    "dockerFile": "Dockerfile",
    "settings": {
        "terminal.integrated.defaultProfile.linux": "zsh"
    }
}
</pre>
</div>

<p>
Dockerfile:
</p>

<div class="org-src-container">
<pre class="src src-dockerfile">FROM ubuntu:20.04

WORKDIR /home/

COPY . .

ENV SHELL /bin/zsh

RUN sh ./setup.sh

RUN echo 'export NVM_DIR="$HOME/.nvm"' &gt;&gt; "$HOME/.zshrc"
RUN echo '\n' &gt;&gt; "$HOME/.zshrc"
RUN echo '[ -s "$NVM_DIR/nvm.sh" ] &amp;&amp; . "$NVM_DIR/nvm.sh"  # This loads nvm' &gt;&gt; "$HOME/.zshrc"
</pre>
</div>

<p>
setup.sh:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #706565;">## </span><span style="color: #857575;">update and install some things we should probably have</span>
apt-get update
apt-get install -y <span style="color: #ddbc91;">\</span>
  curl <span style="color: #ddbc91;">\</span>
  git <span style="color: #ddbc91;">\</span>
  jq <span style="color: #ddbc91;">\</span>
  sudo <span style="color: #ddbc91;">\</span>
  zsh <span style="color: #ddbc91;">\</span>
  autojump

<span style="color: #706565;">## </span><span style="color: #857575;">install nvm</span>
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.38.0/install.sh | bash

<span style="color: #706565;">## </span><span style="color: #857575;">install oh-my-zsh</span>
sh -c <span style="color: #ddbc91;">"$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"</span>
git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ~/.oh-my-zsh/plugins/zsh-syntax-highlighting <span style="color: #706565;"># </span><span style="color: #857575;">install on /root/</span>
git clone https://github.com/zsh-users/zsh-autosuggestions ~/.oh-my-zsh/plugins/zsh-autosuggestions <span style="color: #706565;"># </span><span style="color: #857575;">install on /root/</span>
curl https://raw.githubusercontent.com/tianheg/config/main/shell/nodeys.zsh-theme --output ~/.oh-my-zsh/themes/nodeys.zsh-theme
<span style="color: #9fbfdf;">export</span> <span style="color: #aaca86;">USERNAME</span>=codespace
mkdir /home/$<span style="color: #aaca86;">USERNAME</span>
cp -R /root/.oh-my-zsh /home/$<span style="color: #aaca86;">USERNAME</span>
cp /root/.zshrc /home/$<span style="color: #aaca86;">USERNAME</span>
sed -i -e <span style="color: #ddbc91;">"s/\/root\/.oh-my-zsh/\/home\/$USERNAME\/.oh-my-zsh/g"</span> /home/$<span style="color: #aaca86;">USERNAME</span>/.zshrc <span style="color: #706565;"># </span><span style="color: #857575;">select "/root/.oh-my-zsh", replace it with "/home/$USERNAME/.oh-my-zsh"</span>
chown -R $<span style="color: #aaca86;">USER_UID</span>:$<span style="color: #aaca86;">USER_GID</span> /home/$<span style="color: #aaca86;">USERNAME</span>/.oh-my-zsh /home/$<span style="color: #aaca86;">USERNAME</span>/.zshrc
curl https://raw.githubusercontent.com/tianheg/config/main/shell/zshrc_codespace --output ~/.zshrc
sed -i <span style="color: #ddbc91;">"/# for examples/aif\ test -t l; then\nexec zsh\nfi"</span> ~/.bashrc
</pre>
</div>

<p>
上面的代码已经改过多次。每次修改要重新 Rebuild，要花费小 5
分钟时间。如果碰到网络不好的情况，Rebuild 就会失败。
</p>

<p>
一点一点解决这些小问题也是蛮有意思的。有的是文件夹不存在，有的是文件路径不对，有的是缺少软件，解决的时候不免急躁，因为总是不对，总是报错，很打击我的积极心。但是，在每次出错，我都耐着性子，根据错误日志定位错误，寻找解决办法。在这个过程中，接触了以前没接触的内容：
</p>

<ul class="org-ul">
<li><code>Dockerfile</code> 的命令规则</li>
<li>练习使用 Linux 指令 <code>sed</code></li>
</ul>

<p>
也归纳了我的旧知识：
</p>

<p>
现在安装 Node.js, npm, yarn 只需要安装 nvm
即可。如上述文件中的命令那样，我已经预装了 nvm，安装 Node.js, npm, yarn
只需要以下命令：
</p>

<div class="org-src-container">
<pre class="src src-sh">nvm install --lts <span style="color: #706565;"># </span><span style="color: #857575;">install Node.js, npm</span>
npm install -g yarn <span style="color: #706565;"># </span><span style="color: #857575;">install yarn</span>
</pre>
</div>

<p>
两个命令的顺序不能颠倒，因为第一个命令安装的 npm
是第二个命令能够执行的必要条件。
</p>

<div class="org-src-container">
<pre class="src src-sh">sed -i <span style="color: #ddbc91;">"/# for examples/aif\ test -t l; then\nexec zsh\nfi"</span>
</pre>
</div>

<p>
上面这个命令是为了改变终端 Shell 的，Ubuntu 20.04 的默认 Shell 是
bash，我想用 zsh，于是需要在 <code>.bashrc</code> 的开头添加如下字样：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #91a0b3;">if </span><span style="color: #9fbfdf;">test</span> -t l; <span style="color: #91a0b3;">then</span>
<span style="color: #91a0b3;">exec</span> zsh
<span style="color: #91a0b3;">fi</span>
</pre>
</div>

<p>
ref:
</p>

<ol class="org-ol">
<li><a href="https://github.com/microsoft/vscode-dev-containers">https://github.com/microsoft/vscode-dev-containers</a></li>
<li><a href="https://github.com/codespaces-examples/base">https://github.com/codespaces-examples/base</a></li>
<li><a href="https://github.com/tianheg/new-repo-template">https://github.com/tianheg/new-repo-template</a></li>
</ol>
</div>
</body>
</html>