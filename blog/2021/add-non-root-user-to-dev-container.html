<!DOCTYPE html>
<html lang="zh">
<head>
<!-- 2022-02-07 Mon 22:00 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>将 non-root 用户添加到开发容器中</title>
<meta name="generator" content="Org mode">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/base16/dracula.min.css">
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js"></script>
<link rel="stylesheet" href="/theme/site.css"/>
<script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "d5b841b503ed4d1b8fad459b84d1cc2f"}'></script>
<script defer src="/theme/main.js"></script>
</head>
<body>
<div id="content">
<header>
<h1 class="title">将 non-root 用户添加到开发容器中</h1>
</header><p>
<b>没有成功</b>
</p>

<p>
non-root 即非 root，意思是没有管理员权限（根权限）。
</p>

<p>
默认的 Docker 镜像使用的是 root 用户作为默认用户，但是实际开发中，我需要
non-root 用户，这样使运行环境更安全。
</p>

<div id="outline-container-为-vs-codeserver 指定用户" class="outline-2">
<h2 id="为-vs-codeserver 指定用户">为 VS Code（server）指定用户</h2>
<div class="outline-text-2" id="text-为-vs-codeserver 指定用户">
<p>
如果你使用的镜像或 Dockerfile 已经提供了一个可供选择的 non-root
用户，但默认默认用户仍然是 =root=。可以选择让 VS
Code（server）和任何子进程（终端、任务、调试）使用它，方法是在
devcontainer.json 中指定 remoteUser 属性：
</p>

<pre class="example" id="orgf134e7d">
"remoteUser": "user-name-goes-here"
</pre>

<p>
在 Linux 上，如果在 devcontainer.json 中引用 Dockerfile
或映像，这还将自动更新容器用户的 UID/GID
以匹配的本地用户，从而避免此环境中存在的绑定装入权限问题(除非设置了
<code>"updateremoteuserid": false</code>)。在 Docker Compose 实例中，容器用户的
UID/GID 不会被更新，但是可以在 Dockerfile 中手动更改这些值。
</p>

<p>
由于此设置仅影响 VS 代码和相关子过程，因此需要重新启动 VS
代码（或重新加载窗口）才能生效。但是，UID/GID
更新仅在创建容器时应用，并且需要重新生成才能更改。
</p>
</div>
</div>

<div id="outline-container-创建-non-root-用户" class="outline-2">
<h2 id="创建-non-root-用户">创建 non-root 用户</h2>
<div class="outline-text-2" id="text-创建-non-root-用户">
<pre class="example" id="org9b20101">
ARG USERNAME=user-name-goes-here
ARG USER_UID=1000
ARG USER_GID=$USER_UID

# Create the user
RUN groupadd --gid $USER_GID $USERNAME \
    &amp;&amp; useradd --uid $USER_UID --gid $USER_GID -m $USERNAME \
    #
    # [Optional] Add sudo support. Omit if you don't need to install software after connecting.
    &amp;&amp; apt-get update \
    &amp;&amp; apt-get install -y sudo \
    &amp;&amp; echo $USERNAME ALL=\(root\) NOPASSWD:ALL &gt; /etc/sudoers.d/$USERNAME \
    &amp;&amp; chmod 0440 /etc/sudoers.d/$USERNAME

# ********************************************************
# * Anything else you want to do like clean up goes here *
# ********************************************************

# [Optional] Set the default user. Omit if you want to keep the default as root.
USER $USERNAME
</pre>
</div>
</div>

<div id="outline-container-改变已存在用户的-uidgid" class="outline-2">
<h2 id="改变已存在用户的-uidgid">改变已存在用户的 UID/GID</h2>
<div class="outline-text-2" id="text-改变已存在用户的-uidgid">
<p>
当 remoteUser 属性在 Linux 上使用 Dockerfile
或镜像时尝试根据需要自动更新 UID/GID 时，可以使用 Dockerfile
中的这个代码片段手动更改用户的 UID/GID。根据需要更新 ARG 值。
</p>

<pre class="example" id="orgcc32e4a">
ARG USERNAME=user-name-goes-here
ARG USER_UID=1000
ARG USER_GID=$USER_UID

RUN groupmod --gid $USER_GID $USERNAME \
    &amp;&amp; usermod --uid $USER_UID --gid $USER_GID $USERNAME \
    &amp;&amp; chown -R $USER_UID:$USER_GID /home/$USERNAME
</pre>

<p>
ref:
</p>

<p>
<a href="https://code.visualstudio.com/docs/remote/containers-advanced#_adding-a-nonroot-user-to-your-dev-container">https://code.visualstudio.com/docs/remote/containers-advanced#_adding-a-nonroot-user-to-your-dev-container</a>
</p>
</div>
</div>
</div>
</body>
</html>